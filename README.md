# PepeEdtaBot

Telegram-бот для группового чата с генерацией реплик на Markov chain без ML.

Текущая версия использует **модель переменного порядка**:
- основной порядок: `n=3` (триграммы),
- запасной порядок: `n=2`,
- запасной порядок: `n=1` (если включен откат на низшие порядки).

Это снижает копипаст и улучшает связность ответов по сравнению с чистыми биграммами.

## Стек
- Python 3.11+
- aiogram v3 (async, long polling)
- SQLite + aiosqlite
- Конфиг через `.env`

## Быстрый старт
```bash
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```

1. Создайте `.env` из `.env.example`.
2. Заполните `BOT_TOKEN` (и `OWNER_ID`, если нужен приоритетный доступ к управлению).
3. Запустите:
```bash
python main.py
```

## Конфигурация (`.env`)
Все параметры уже задокументированы комментариями в `.env.example`.

Ключевые:
- `REPLY_PROBABILITY` — вероятность случайного ответа без прямого обращения.
- `MIN_COOLDOWN_SEC` — антиспам-кулдаун.
- `MIN_TOKENS_FOR_MODEL` — минимальный объём модели перед генерацией.
- `RANDOMNESS_STRENGTH` (`0..3`) — сила вариативности генерации.
- `MARKOV_ORDER` (`2`/`3`) — основной порядок модели.
- `ENABLE_BACKOFF` (`true`/`false`) — включить откат на низшие порядки.
- `BACKOFF_MIN_ORDER` (`1`/`2`) — минимальный порядок такого отката.

## Логика обучения
Для каждого `chat_id` бот:
1. Сохраняет исходный `raw_text` в `messages`.
2. Очищает текст:
   - удаляет ссылки,
   - удаляет `@mentions`,
   - нормализует повторы и пробелы.
3. Токенизирует в `слова + . , ! ? ; :`.
4. Обновляет статистику переходов:
   - `starts3`: `(w1,w2,w3)` — стартовые триплеты;
   - `transitions3`: `(w1,w2,w3)->w4`;
   - `starts`: `(w1,w2)` — запасные старты;
   - `transitions`: `(w1,w2)->w3`;
   - `transitions1`: `w1->w2`.

## Логика генерации
1. Старт берется из `starts3` (или из заданного seed).
2. На каждом шаге:
   - сначала пробуются `transitions3`,
   - если нет — `transitions` (n=2),
   - если нет и разрешено — `transitions1` (n=1).
3. Применяются:
   - взвешенный random с управлением `RANDOMNESS_STRENGTH`,
   - анти-циклы,
   - анти-копипаст (отбрасывание ответа, если он дословно совпал с историческим сообщением).

## Когда бот отвечает
- При обращении к боту (mention/reply) — пытается ответить обязательно.
- Без обращения — вероятностно (`REPLY_PROBABILITY`) и с кулдауном.
- Если модель ещё мала — отвечает, что материала недостаточно.

## Команды
- `/help` — список команд.
- `/ping` — проверка realtime-работы.
- `/stats` — статистика модели по чату.
- `/config` — текущие настройки процесса во время работы.
- `/set <key> <value>` — изменение параметров во время работы (`OWNER_ID` или админ чата).
- `/setprob 0.2` — быстрый сеттер вероятности ответа (`OWNER_ID` или админ чата).
- `/seed "текст"` — одноразовый seed для следующей генерации (`OWNER_ID` или админ чата).
- `/clear` — очистка данных текущего чата (`OWNER_ID` или админ чата).

## Миграция со старой версии
Схема расширяется автоматически при старте.

Если хотите начать с чистого состояния:
1. остановите бота,
2. удалите `markov.db`, `markov.db-wal`, `markov.db-shm`,
3. запустите бота снова.

## Важно для групп
Отключите privacy mode у бота в BotFather:
`Bot Settings -> Group Privacy -> Turn off`.

## Безопасность
- Не коммитьте `.env`.
- Не храните реальные токены в репозитории.
- При утечке токена перевыпустите его в BotFather.
